name: Sync with Upstream

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/pyclashbot/py-clash-bot.git || true
          git remote -v

      - name: Fetch upstream changes
        run: git fetch upstream

      - name: Check for updates
        id: check_updates
        run: |
          # Get the latest commit from upstream
          UPSTREAM_COMMIT=$(git rev-parse upstream/master)
          # Get the latest commit from our master branch
          LOCAL_COMMIT=$(git rev-parse origin/master)
          
          if [ "$UPSTREAM_COMMIT" = "$LOCAL_COMMIT" ]; then
            echo "No updates from upstream"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "Updates available from upstream"
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

      - name: Attempt merge with upstream
        if: steps.check_updates.outputs.has_updates == 'true'
        id: merge
        run: |
          git checkout master
          
          # Try to merge upstream changes
          if git merge upstream/master --no-edit; then
            echo "Merge successful"
            echo "merge_status=success" >> $GITHUB_OUTPUT
          else
            echo "Merge conflicts detected"
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            git merge --abort
          fi

      - name: Push changes
        if: steps.check_updates.outputs.has_updates == 'true' && steps.merge.outputs.merge_status == 'success'
        run: |
          git push origin master

      - name: Create issue on conflict
        if: steps.check_updates.outputs.has_updates == 'true' && steps.merge.outputs.merge_status == 'conflict'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync-conflict'
            });
            
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Upstream sync conflict detected',
                body: `The automatic sync with the upstream repository (pyclashbot/py-clash-bot) has detected merge conflicts.\n\n` +
                      `Please manually resolve these conflicts by:\n` +
                      `1. Clone the repository\n` +
                      `2. Add the upstream remote: \`git remote add upstream https://github.com/pyclashbot/py-clash-bot.git\`\n` +
                      `3. Fetch upstream: \`git fetch upstream\`\n` +
                      `4. Merge: \`git merge upstream/master\`\n` +
                      `5. Resolve conflicts\n` +
                      `6. Push: \`git push origin master\`\n\n` +
                      `This issue will be automatically closed when the sync succeeds.`,
                labels: ['upstream-sync-conflict', 'automated']
              });
            }

      - name: Close conflict issues on success
        if: steps.check_updates.outputs.has_updates == 'true' && steps.merge.outputs.merge_status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync-conflict'
            });
            
            for (const issue of issues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'The upstream sync has been successfully completed. This issue is now closed.'
              });
            }
